<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#ff7a2b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="ガチャ抽選" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />
  <title>ローカルガチャ抽選機</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #f4f4f4;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 24px;
    }

    .app {
      width: min(960px, 100vw - 48px);
      margin: 0 auto;
      text-align: center;
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 4px;
    }

    .description {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 12px;
    }

    .machine {
      background: #ffffff;
      border-radius: 16px;
      padding: 20px 20px 22px;
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.14);
      position: relative;
      overflow: hidden;
    }

    .window {
      width: 100%;
      aspect-ratio: 4 / 3;
      background: linear-gradient(135deg, #fefefe, #f0f0f0);
      border-radius: 16px;
      border: 2px solid #ddd;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      position: relative;
      margin-bottom: 12px;
    }

    .window img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      transition: opacity 0.2s ease-out, transform 0.2s ease-out;
    }

    .placeholder-text {
      position: absolute;
      font-size: 0.9rem;
      color: #888;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.8);
      border: 1px dashed #ccc;
    }

    .ball {
      position: absolute;
      bottom: -32px;
      left: 50%;
      transform: translateX(-50%);
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff, #90caf9);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
      opacity: 0;
      pointer-events: none;
    }

    .ball.show {
      animation: ballDrop 0.5s ease-out forwards;
    }

    @keyframes ballDrop {
      0% {
        transform: translate(-50%, 10px) scale(0.5);
        opacity: 0;
      }
      100% {
        transform: translate(-50%, 0) scale(1);
        opacity: 1;
      }
    }

    .ball.hide {
      animation: ballHide 0.3s ease-in forwards;
    }

    @keyframes ballHide {
      0% {
        opacity: 1;
        transform: translate(-50%, 0) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, 10px) scale(0.7);
      }
    }

    .session-summary {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin: 14px 0 8px;
    }

    .summary-item {
      background: linear-gradient(135deg, #fff2e3, #ffe3d0);
      border-radius: 12px;
      padding: 12px;
      text-align: left;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6),
        0 8px 16px rgba(0, 0, 0, 0.1);
    }

    .summary-label {
      font-size: 0.8rem;
      color: #8a4b20;
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 1.2rem;
      font-weight: 700;
      color: #d84315;
    }

    .status-panel {
      display: grid;
      grid-template-columns: 1.3fr 1.7fr;
      gap: 6px 10px;
      font-size: 0.8rem;
      margin-bottom: 4px;
      text-align: left;
    }

    .status-label {
      color: #666;
    }

    .status-value {
      font-weight: 600;
    }

    .status-part {
      grid-column: 1 / -1;
      font-weight: 600;
      color: #444;
    }

    .status-breakdown {
      margin-top: 4px;
      font-size: 0.75rem;
      color: #555;
      text-align: left;
    }

    .gacha-controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 8px;
    }

    .slot-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .gacha-button {
      width: 100%;
      padding: 18px 12px;
      border-radius: 16px;
      border: none;
      font-size: 1rem;
      font-weight: 800;
      letter-spacing: 0.5px;
      background: linear-gradient(135deg, #ffb347, #ff7043);
      color: #fff;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2), inset 0 2px 0 rgba(255, 255, 255, 0.5);
      cursor: pointer;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out,
        opacity 0.2s;
      position: relative;
      overflow: hidden;
    }

    .gacha-button::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 40%;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.7), transparent);
      pointer-events: none;
    }

    .gacha-button:active {
      transform: translateY(1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.24), inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }

    .gacha-button[disabled] {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .next-person-row {
      margin-top: 10px;
    }

    .next-person-button {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: none;
      font-size: 0.95rem;
      font-weight: 800;
      letter-spacing: 0.2px;
      background: linear-gradient(135deg, #ffa351, #ff7043);
      color: #fff;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
      cursor: pointer;
    }

    .session-inline {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      background: #fff5eb;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6),
        0 4px 10px rgba(0, 0, 0, 0.06);
      font-size: 0.9rem;
    }

    .session-inline label {
      font-weight: 700;
      color: #d25b21;
      white-space: nowrap;
    }

    .session-inline input {
      width: 100%;
      font-size: 0.95rem;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #e0c7b2;
    }

    .session-inline button {
      padding: 8px 12px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(135deg, #ff9800, #ff7043);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }

    .sub-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    .sub-buttons button {
      flex: 1 1 30%;
      padding: 6px 8px;
      border-radius: 999px;
      border: none;
      font-size: 0.75rem;
      background: #eee;
      cursor: pointer;
    }

    .sub-buttons button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .result-text {
      margin-top: 18px;
      font-size: 1.15rem;
      font-weight: 700;
      min-height: 1.5em;
    }

    .details-toggle-row {
      margin-top: 12px;
      text-align: center;
    }

    .details-toggle-row button {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 0.95rem;
      background: #f0f0f0;
      cursor: pointer;
    }

    .details-panel {
      display: none;
      margin-top: 10px;
      background: #f9f9f9;
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    .details-panel.open {
      display: block;
    }

    .settings-link {
      margin-top: 16px;
      text-align: center;
    }

    .settings-link a {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 10px;
      background: #f0f0f0;
      color: #333;
      text-decoration: none;
      font-weight: 700;
    }

    .footer {
      margin-top: 10px;
      font-size: 0.75rem;
      color: #999;
      text-align: left;
    }

    .settings {
      margin-top: 18px;
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
      text-align: left;
      font-size: 0.8rem;
    }

    .settings h2 {
      font-size: 0.95rem;
      margin-bottom: 6px;
    }

    .settings .note {
      color: #777;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .settings .env {
      font-size: 0.74rem;
      color: #999;
      margin-bottom: 6px;
    }

    .settings-section-title {
      margin-top: 10px;
      margin-bottom: 4px;
      font-size: 0.88rem;
      font-weight: 600;
    }

    .settings-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .settings-row label {
      min-width: 90px;
      font-size: 0.78rem;
      color: #555;
    }

    .settings-row input[type="number"],
    .settings-row input[type="text"] {
      flex: 1;
      font-size: 0.8rem;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      min-width: 0;
    }

    .settings-row button.settings-main-btn {
      flex: 1;
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      background: #1976d2;
      color: #fff;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .image-setting-row,
    .sound-setting-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .image-setting-row span.key-label,
    .sound-setting-row span.key-label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: #eee;
      font-size: 0.8rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    .image-preview {
      width: 28px;
      height: 28px;
      border-radius: 4px;
      object-fit: cover;
      border: 1px solid #ddd;
      flex-shrink: 0;
    }

    .small-label {
      font-size: 0.7rem;
      white-space: nowrap;
    }

    .prize-label-input {
      flex: 1;
      min-width: 80px;
      font-size: 0.75rem;
      padding: 3px 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .prize-win-count {
      width: 56px;
      font-size: 0.7rem;
      padding: 3px 4px;
    }

    .sound-label-text {
      min-width: 80px;
      font-size: 0.75rem;
    }

    .image-setting-row input[type="file"],
    .sound-setting-row input[type="file"] {
      flex: 1;
      font-size: 0.72rem;
    }

    .image-setting-row button,
    .sound-setting-row button {
      border: none;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 0.7rem;
      background: #eee;
      cursor: pointer;
      flex-shrink: 0;
    }

    .settings-footer {
      margin-top: 4px;
      font-size: 0.7rem;
      color: #aaa;
    }

    @media (max-width: 820px) {
      body {
        align-items: flex-start;
      }
      .app {
        width: min(100%, 560px);
      }
      .slot-buttons {
        gap: 6px;
      }
      .summary-value {
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1 id="app-title">ローカルガチャ抽選機</h1>

    <div class="machine">
      <div class="window">
        <img id="result-image" src="" alt="ガチャ結果" style="opacity: 0" />
        <div id="placeholder-text" class="placeholder-text">
          ボタンを押してスタート
        </div>
      </div>
      <div id="ball" class="ball"></div>

      <div class="session-summary" aria-label="今回のサマリー">
        <div class="summary-item">
          <div class="summary-label">今回の試行</div>
          <div class="summary-value" id="summary-drawn-count">0回</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">当たり</div>
          <div class="summary-value" id="summary-win-count">0回</div>
        </div>
      </div>

      <div class="gacha-controls">
        <div class="slot-buttons" role="group" aria-label="ガチャボタン">
          <button class="gacha-button" type="button">START!</button>
          <button class="gacha-button" type="button">START!</button>
          <button class="gacha-button" type="button">START!</button>
        </div>
        <div id="result-text" class="result-text"></div>

        <div class="next-person-row">
          <button id="next-person-button" class="next-person-button" type="button">
            次の人へ
          </button>
        </div>

        <div class="session-inline">
          <label for="input-session-draws">今回の挑戦回数</label>
          <input
            id="input-session-draws"
            type="number"
            min="1"
            step="1"
            placeholder="例: 3"
          />
          <button id="apply-session-button" type="button">セット</button>
        </div>

        <div class="sub-buttons">
          <button id="undo-button" type="button">1回戻す</button>
          <button id="next-part-button" type="button">次の部へ</button>
        </div>
      </div>

      <div class="details-toggle-row">
        <button id="details-toggle" type="button">詳細を表示</button>
      </div>
      <div id="details-panel" class="details-panel" aria-live="polite">
        <div class="status-panel">
          <div class="status-part" id="status-part"></div>

          <div class="status-label">残り当たり</div>
          <div class="status-value" id="status-remaining-wins"></div>

          <div class="status-label">残りくじ</div>
          <div class="status-value" id="status-remaining-tickets"></div>

          <div class="status-label">試行数</div>
          <div class="status-value" id="status-drawn-count"></div>

          <div class="status-label">当たり回数</div>
          <div class="status-value" id="status-win-count"></div>

          <div class="status-label">今回残り回数</div>
          <div class="status-value" id="status-session-draws"></div>
        </div>
        <div id="status-win-breakdown" class="status-breakdown"></div>
      </div>
    </div>

      <div class="settings-link">
        <a href="settings.html">設定ページを開く</a>
      </div>
  </div>

  <script>
    const PRIZE_KEYS = ["A", "B", "C", "D", "E"];

    // Register Service Worker for PWA install/offline on iPad and other devices.
    const enableServiceWorker =
      "serviceWorker" in navigator &&
      (window.isSecureContext ||
        location.protocol === "https:" ||
        location.hostname === "localhost" ||
        location.hostname === "127.0.0.1");

    if (enableServiceWorker) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("./sw.js")
          .catch((err) =>
            console.warn("Service Worker registration failed:", err)
          );
      });
    }

    // ===== 画像ソース管理 =====
    const IMAGE_STORAGE_KEY = "gachaImageSourcesV1";
    let imageSources = {};

    function loadImageSources() {
      try {
        const raw = localStorage.getItem(IMAGE_STORAGE_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === "object") {
            imageSources = parsed;
          }
        }
      } catch (e) {
        imageSources = {};
      }
    }

    function saveImageSources() {
      try {
        localStorage.setItem(IMAGE_STORAGE_KEY, JSON.stringify(imageSources));
      } catch (e) {}
    }

    function getImageSrc(key, defaultPath) {
      if (imageSources && imageSources[key]) {
        return imageSources[key];
      }
      return defaultPath;
    }

    loadImageSources();

    // ===== サウンドソース管理 =====
    const SOUND_STORAGE_KEY = "gachaSoundSourcesV1";
    let soundSources = {};

    function loadSoundSources() {
      try {
        const raw = localStorage.getItem(SOUND_STORAGE_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === "object") {
            soundSources = parsed;
          }
        }
      } catch (e) {
        soundSources = {};
      }
    }

    function saveSoundSources() {
      try {
        localStorage.setItem(SOUND_STORAGE_KEY, JSON.stringify(soundSources));
      } catch (e) {}
    }

    function getSoundSrc(key, defaultPath) {
      if (soundSources && soundSources[key]) {
        return soundSources[key];
      }
      return defaultPath;
    }

    loadSoundSources();

    function createAudio(src) {
      const audio = new Audio(src);
      audio.preload = "auto";
      audio.playsInline = true;
      return audio;
    }

    let startSound = createAudio(getSoundSrc("start", "roulette.mp3"));
    let resultWinSound = createAudio(getSoundSrc("resultWin", "atari.mp3"));
    let resultLoseSound = createAudio(getSoundSrc("resultLose", "hazure.mp3"));

    // Unlock audio on iOS/WKWebView which blocks playback until a user gesture.
    const audioUnlockEvents = ["pointerdown", "touchstart", "click", "keydown"];
    let audioUnlocked = false;

    function unlockAudio() {
      if (audioUnlocked) return;
      audioUnlocked = true;

      try {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (AudioCtx) {
          const ctx = new AudioCtx();
          ctx.resume().catch(() => {});
        }
      } catch (e) {}

      [startSound, resultWinSound, resultLoseSound].forEach((audio) => {
        if (!audio) return;
        try {
          audio.muted = true;
          const p = audio.play();
          if (p && typeof p.catch === "function") {
            p.catch(() => {});
          }
          audio.pause();
          audio.currentTime = 0;
          audio.muted = false;
        } catch (e) {}
      });

      audioUnlockEvents.forEach((ev) =>
        document.removeEventListener(ev, unlockAudio, true)
      );
    }

    audioUnlockEvents.forEach((ev) =>
      document.addEventListener(ev, unlockAudio, {
        capture: true,
        passive: true,
      })
    );

    async function playSafe(audio, limitMs) {
      if (!audio) return;
      try {
        audio.currentTime = 0;
        const p = audio.play();
        if (limitMs && limitMs > 0) {
          setTimeout(() => {
            try {
              audio.pause();
              audio.currentTime = 0;
            } catch (e) {}
          }, limitMs);
        }
        await p;
      } catch (e) {
        console.warn("サウンド再生に失敗しました:", e);
      }
    }

    // ===== 抽選ロジック用状態管理 =====
    const LOTTERY_STORAGE_KEY = "gachaLotteryStateV3";

    let lotteryState = {
      version: 3,
      currentPart: 1,
      config: {
        totalTickets: 100,
        totalWins: 10,
        title: "ローカルガチャ抽選機",
        winText: "大当たり！",
        maxSessionDraw: 3, // ★ 初期は 3 回挑戦できる
      },
      prizes: [],
      state: {
        drawnCount: 0,
        winCount: 0,
        personDrawnCount: 0,
        personWinCount: 0,
        remainingTickets: 100,
        remainingWins: 10,
        prizeRemainingWins: {},
        sessionRemainingDraws: 3, // ★ 初期は 3 回
      },
      lastDraw: null, // {outcome, prizeKey}
    };

    function loadLotteryState() {
      try {
        const raw = localStorage.getItem(LOTTERY_STORAGE_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === "object" && parsed.config && parsed.state) {
            lotteryState = parsed;
          }
        }
      } catch (e) {
        // ignore
      }
    }

    function saveLotteryState() {
      try {
        localStorage.setItem(LOTTERY_STORAGE_KEY, JSON.stringify(lotteryState));
      } catch (e) {}
    }

    function ensurePrizesInitialized() {
      if (!Array.isArray(lotteryState.prizes)) {
        lotteryState.prizes = [];
      }

      const existingKeys = new Set(lotteryState.prizes.map((p) => p.key));

      // 初回は A だけ当たり10本、他はハズレとして追加
      PRIZE_KEYS.forEach((key) => {
        if (!existingKeys.has(key)) {
          lotteryState.prizes.push({
            key,
            label: key + "賞",
            defaultPath: key.toLowerCase() + ".png",
            enabled: true,
            isWin: key === "A",
            winCountTotal: key === "A" ? 10 : 0,
          });
        }
      });

      // config の整合性
      const sumWins =
        lotteryState.prizes.reduce(
          (acc, p) =>
            acc + (p.enabled && p.isWin ? (p.winCountTotal || 0) : 0),
          0
        ) || 0;

      if (
        !lotteryState.config ||
        typeof lotteryState.config.totalTickets !== "number" ||
        lotteryState.config.totalTickets <= 0
      ) {
        lotteryState.config = {
          totalTickets: Math.max(sumWins || 100, 1),
          totalWins: sumWins || 10,
          title: "ローカルガチャ抽選機",
          winText: "大当たり！",
          maxSessionDraw: 3, // ★ 初期挑戦回数
        };
      } else {
        lotteryState.config.totalWins = sumWins;
        if (!("maxSessionDraw" in lotteryState.config)) {
          lotteryState.config.maxSessionDraw = 3;
        }
        if (!("title" in lotteryState.config)) {
          lotteryState.config.title = "ローカルガチャ抽選機";
        }
      }

      if (!lotteryState.state || typeof lotteryState.state !== "object") {
        lotteryState.state = {
          drawnCount: 0,
          winCount: 0,
          personDrawnCount: 0,
          personWinCount: 0,
          remainingTickets: lotteryState.config.totalTickets,
          remainingWins: sumWins,
          prizeRemainingWins: {},
          sessionRemainingDraws:
            lotteryState.config.maxSessionDraw != null
              ? lotteryState.config.maxSessionDraw
              : null,
        };
      }

      if (!lotteryState.state.prizeRemainingWins) {
        lotteryState.state.prizeRemainingWins = {};
        let remWins = 0;
        lotteryState.prizes.forEach((p) => {
          const w = p.enabled && p.isWin ? (p.winCountTotal || 0) : 0;
          lotteryState.state.prizeRemainingWins[p.key] = w;
          remWins += w;
        });
        lotteryState.state.remainingWins = remWins;
      }

      if (!("personDrawnCount" in lotteryState.state)) {
        lotteryState.state.personDrawnCount = 0;
      }
      if (!("personWinCount" in lotteryState.state)) {
        lotteryState.state.personWinCount = 0;
      }

      if (
        lotteryState.config.maxSessionDraw != null &&
        (lotteryState.state.sessionRemainingDraws == null ||
          lotteryState.state.sessionRemainingDraws >
            lotteryState.config.maxSessionDraw)
      ) {
        lotteryState.state.sessionRemainingDraws =
          lotteryState.config.maxSessionDraw;
      }

      saveLotteryState();
    }

    loadLotteryState();
    ensurePrizesInitialized();

    // ===== DOM 取得 =====
    const appTitle = document.getElementById("app-title");
    const resultImage = document.getElementById("result-image");
    const placeholderText = document.getElementById("placeholder-text");
    const gachaButtons = Array.from(document.querySelectorAll(".gacha-button"));
    const undoButton = document.getElementById("undo-button");
    const nextPersonButton = document.getElementById("next-person-button");
    const nextPartButton = document.getElementById("next-part-button");
    const resultText = document.getElementById("result-text");
    const ball = document.getElementById("ball");

    const statusPart = document.getElementById("status-part");
    const statusRemainingWins = document.getElementById(
      "status-remaining-wins"
    );
    const statusRemainingTickets = document.getElementById(
      "status-remaining-tickets"
    );
    const statusDrawnCount = document.getElementById("status-drawn-count");
    const statusWinCount = document.getElementById("status-win-count");
    const statusSessionDraws = document.getElementById("status-session-draws");
    const statusWinBreakdown = document.getElementById("status-win-breakdown");
    const summaryDrawnCount = document.getElementById("summary-drawn-count");
    const summaryWinCount = document.getElementById("summary-win-count");
    const detailsToggle = document.getElementById("details-toggle");
    const detailsPanel = document.getElementById("details-panel");

    const inputTitle = document.getElementById("input-title");
    const inputTotalTickets = document.getElementById("input-total-tickets");
    const inputTotalWins = document.getElementById("input-total-wins");
    const inputWinText = document.getElementById("input-win-text");
    const inputSessionDraws = document.getElementById("input-session-draws");
    const applyConfigButton = document.getElementById("apply-config-button");
    const applySessionButton = document.getElementById("apply-session-button");
    const envInfo = document.getElementById("env-info");

    resultImage.addEventListener("error", () => {
      console.warn("画像を読み込めませんでした:", resultImage.src);
    });

    try {
      const href = location.href || "";
      if (envInfo) {
        if (href.startsWith("content://")) {
          envInfo.textContent =
            "現在のURL: content:// ... （ローカルファイル・コンテンツ経由）";
        } else if (href.startsWith("file://")) {
          envInfo.textContent = "現在のURL: file:// ... （ローカルファイル）";
        } else if (href.startsWith("http")) {
          envInfo.textContent = "現在のURL: " + href.split("#")[0];
        }
      }
    } catch (e) {
      if (envInfo) envInfo.textContent = "";
    }

    let isSpinning = false;

    // ===== 表示更新系 =====
    function getPrizeLabel(prize) {
      if (prize && prize.label && prize.label.trim() !== "") {
        return prize.label.trim();
      }
      return prize ? prize.key + "賞" : "";
    }

    function updateStatusDisplay() {
      const c = lotteryState.config;
      const s = lotteryState.state;
      statusPart.textContent = `現在の部：第 ${lotteryState.currentPart} 部`;
      statusRemainingWins.textContent = `${s.remainingWins} 本 / ${c.totalWins} 本`;
      statusRemainingTickets.textContent = `${s.remainingTickets} 枚 / ${c.totalTickets} 枚`;
      statusDrawnCount.textContent = `${s.drawnCount} 回`;
      statusWinCount.textContent = `${s.winCount} 回`;
      summaryDrawnCount.textContent = `${s.personDrawnCount || 0} 回`;
      summaryWinCount.textContent = `${s.personWinCount || 0} 回`;

      if (c.maxSessionDraw == null) {
        statusSessionDraws.textContent = "無制限";
      } else {
        const rem = s.sessionRemainingDraws != null ? s.sessionRemainingDraws : 0;
        statusSessionDraws.textContent = `${rem} 回 / ${c.maxSessionDraw} 回`;
      }

      const prizes = lotteryState.prizes || [];
      const breakdownItems = [];
      prizes.forEach((p) => {
        if (!p.enabled || !p.isWin || !(p.winCountTotal > 0)) return;
        const rem =
          s.prizeRemainingWins && typeof s.prizeRemainingWins[p.key] === "number"
            ? s.prizeRemainingWins[p.key]
            : 0;
        const label = getPrizeLabel(p);
        breakdownItems.push(
          `${label}: 残り${rem}本 / 全${p.winCountTotal}本`
        );
      });
      if (breakdownItems.length === 0) {
        statusWinBreakdown.textContent = "残り当たり内訳: （設定されていません）";
      } else {
        statusWinBreakdown.textContent =
          "残り当たり内訳: " + breakdownItems.join(" ／ ");
      }
    }

    function updateTitleDisplay() {
      if (!appTitle) return;
      appTitle.textContent =
        (lotteryState.config && lotteryState.config.title) ||
        "ローカルガチャ抽選機";
    }

    function clearResultDisplay() {
      resultText.textContent = "";
      if (lotteryState.state.drawnCount === 0) {
        placeholderText.style.display = "block";
        resultImage.style.opacity = 0;
      }
    }

    function updateConfigInputs() {
      const c = lotteryState.config;
      if (inputTitle) inputTitle.value = c.title || "ローカルガチャ抽選機";
      if (inputTotalTickets) inputTotalTickets.value = c.totalTickets;
      if (inputTotalWins) inputTotalWins.value = c.totalWins;
      if (inputWinText) inputWinText.value = c.winText || "";
      if (inputSessionDraws) {
        if (c.maxSessionDraw != null) {
          inputSessionDraws.value = c.maxSessionDraw;
        } else {
          inputSessionDraws.value = "";
        }
      }
    }

    function updateButtonsState() {
      const s = lotteryState.state;
      const c = lotteryState.config;
      const sessionBlocked =
        c.maxSessionDraw != null &&
        s.sessionRemainingDraws != null &&
        s.sessionRemainingDraws <= 0;
      undoButton.disabled = !lotteryState.lastDraw;
      const gachaDisabled =
        s.remainingTickets <= 0 || isSpinning || sessionBlocked;
      gachaButtons.forEach((btn) => {
        btn.disabled = gachaDisabled;
      });
    }

    updateStatusDisplay();
    updateConfigInputs();
    updateTitleDisplay();
    updateButtonsState();

    // ===== 抽選ロジック =====
    function resetStateForCurrentPart() {
      const c = lotteryState.config;
      const prizes = lotteryState.prizes;
      const prizeRemainingWins = {};
      let totalWins = 0;
      prizes.forEach((p) => {
        const w = p.enabled && p.isWin ? (p.winCountTotal || 0) : 0;
        prizeRemainingWins[p.key] = w;
        totalWins += w;
      });
      lotteryState.config.totalWins = totalWins;
      lotteryState.state = {
        drawnCount: 0,
        winCount: 0,
        personDrawnCount: 0,
        personWinCount: 0,
        remainingTickets: c.totalTickets,
        remainingWins: totalWins,
        prizeRemainingWins,
        sessionRemainingDraws:
          c.maxSessionDraw != null ? c.maxSessionDraw : null,
      };
      lotteryState.lastDraw = null;
      saveLotteryState();
      updateStatusDisplay();
      updateButtonsState();
      clearResultDisplay();
    }

    function prepareForNextPerson() {
      const c = lotteryState.config;
      const s = lotteryState.state;

      s.sessionRemainingDraws = 0;
      s.personDrawnCount = 0;
      s.personWinCount = 0;

      lotteryState.lastDraw = null;
      saveLotteryState();
      updateStatusDisplay();
      updateButtonsState();
      placeholderText.style.display = "block";
      resultImage.style.opacity = 0;
      resultText.textContent = "";
      resultSub.textContent = "";
      ball.classList.remove("show");
      ball.classList.add("hide");
      if (inputSessionDraws) {
        inputSessionDraws.value = "";
      }
    }

    function nextPart() {
      lotteryState.currentPart += 1;
      resetStateForCurrentPart();
    }

    function performDraw() {
      const s = lotteryState.state;
      const c = lotteryState.config;
      const prizes = lotteryState.prizes;

      if (s.remainingTickets <= 0) {
        resultText.textContent = "くじはすべて引き終わりました。";
        resultSub.textContent = "";
        return null;
      }

      if (
        c.maxSessionDraw != null &&
        s.sessionRemainingDraws != null &&
        s.sessionRemainingDraws <= 0
      ) {
        resultText.textContent = "今回の挑戦回数は終了しました。";
        resultSub.textContent =
          "設定から次の挑戦回数を入力してください。";
        return null;
      }

      const R = s.remainingTickets;
      const W = s.remainingWins || 0;

      let outcome = "lose";
      let prizeKey = null;

      if (W > 0) {
        const r = Math.random() * R;
        if (r < W) {
          outcome = "win";
        }
      }

      s.drawnCount += 1;
      s.personDrawnCount = (s.personDrawnCount || 0) + 1;
      s.remainingTickets -= 1;

      if (c.maxSessionDraw != null && s.sessionRemainingDraws != null) {
        s.sessionRemainingDraws = Math.max(
          0,
          s.sessionRemainingDraws - 1
        );
      }

      if (outcome === "win") {
        const winPrizes = prizes.filter(
          (p) =>
            p.enabled &&
            p.isWin &&
            s.prizeRemainingWins &&
            s.prizeRemainingWins[p.key] > 0
        );
        if (winPrizes.length === 0) {
          outcome = "lose";
        } else {
          let totalRemWins = 0;
          winPrizes.forEach((p) => {
            totalRemWins += s.prizeRemainingWins[p.key];
          });
          let rnd = Math.random() * totalRemWins;
          let chosen = winPrizes[0];
          for (const p of winPrizes) {
            const w = s.prizeRemainingWins[p.key];
            if (rnd < w) {
              chosen = p;
              break;
            }
            rnd -= w;
          }
          prizeKey = chosen.key;
          s.prizeRemainingWins[prizeKey] -= 1;
          s.remainingWins -= 1;
          s.winCount += 1;
          s.personWinCount = (s.personWinCount || 0) + 1;
        }
      }

      if (outcome === "lose") {
        const losePrizes = prizes.filter((p) => p.enabled && !p.isWin);
        if (losePrizes.length > 0) {
          const idx = Math.floor(Math.random() * losePrizes.length);
          prizeKey = losePrizes[idx].key;
        } else {
          prizeKey = null;
        }
      }

      lotteryState.lastDraw = { outcome, prizeKey };
      saveLotteryState();
      updateStatusDisplay();
      updateButtonsState();

      return { outcome, prizeKey };
    }

    function undoLastDraw() {
      const last = lotteryState.lastDraw;
      if (!last) return;
      const s = lotteryState.state;
      const c = lotteryState.config;
      if (s.drawnCount <= 0) {
        lotteryState.lastDraw = null;
        updateButtonsState();
        return;
      }

      s.drawnCount -= 1;
      if (s.personDrawnCount && s.personDrawnCount > 0) {
        s.personDrawnCount -= 1;
      }
      s.remainingTickets += 1;

      if (c.maxSessionDraw != null) {
        if (s.sessionRemainingDraws == null) {
          s.sessionRemainingDraws = 1;
        } else {
          s.sessionRemainingDraws += 1;
          if (s.sessionRemainingDraws > c.maxSessionDraw) {
            s.sessionRemainingDraws = c.maxSessionDraw;
          }
        }
      }

      if (last.outcome === "win") {
        s.winCount -= 1;
        if (s.personWinCount && s.personWinCount > 0) {
          s.personWinCount -= 1;
        }
        s.remainingWins += 1;
        if (
          last.prizeKey &&
          s.prizeRemainingWins &&
          typeof s.prizeRemainingWins[last.prizeKey] === "number"
        ) {
          s.prizeRemainingWins[last.prizeKey] += 1;
        }
      }

      lotteryState.lastDraw = null;
      saveLotteryState();
      updateStatusDisplay();
      updateButtonsState();

      if (s.drawnCount === 0) {
        placeholderText.style.display = "block";
        resultImage.style.opacity = 0;
        resultText.textContent = "";
      }
    }

    function getFinalImageForOutcome(outcome, prizeKey) {
      if (prizeKey) {
        const defPath = prizeKey.toLowerCase() + ".png";
        return getImageSrc(prizeKey, defPath);
      }
      if (outcome === "win") {
        return getImageSrc("A", "a.png");
      }
      return getImageSrc("E", "e.png");
    }

    function getEnabledPrizeKeys() {
      const prizes = lotteryState.prizes || [];
      return prizes.filter((p) => p.enabled).map((p) => p.key);
    }

    function spinGacha() {
      const s = lotteryState.state;
      const c = lotteryState.config;
      const sessionBlocked =
        c.maxSessionDraw != null &&
        s.sessionRemainingDraws != null &&
        s.sessionRemainingDraws <= 0;

      if (isSpinning || s.remainingTickets <= 0 || sessionBlocked) {
        if (sessionBlocked) {
          resultText.textContent = "今回の挑戦回数は終了しました。";
        }
        return;
      }

      isSpinning = true;
      updateButtonsState();

      resultText.textContent = "抽選中...";
      placeholderText.style.display = "none";

      playSafe(startSound, 1000);

      ball.classList.remove("hide");
      ball.classList.add("show");

      let tempKeys = getEnabledPrizeKeys();
      if (tempKeys.length === 0) {
        tempKeys = ["A", "B", "C", "D", "E"];
      }

      const spinInterval = setInterval(() => {
        const key = tempKeys[Math.floor(Math.random() * tempKeys.length)];
        const defPath = key.toLowerCase() + ".png";
        resultImage.src = getImageSrc(key, defPath);
        resultImage.style.opacity = 0.5;
        resultImage.style.transform = "scale(0.95)";
      }, 80);

      setTimeout(() => {
        clearInterval(spinInterval);

        const drawResult = performDraw();
        if (!drawResult) {
          isSpinning = false;
          updateButtonsState();
          ball.classList.remove("show");
          ball.classList.add("hide");
          return;
        }

        const { outcome, prizeKey } = drawResult;
        const finalImageSrc = getFinalImageForOutcome(outcome, prizeKey);
        resultImage.src = finalImageSrc;

        resultImage.style.opacity = 1;
        resultImage.style.transform = "scale(1.02)";
        setTimeout(() => {
          resultImage.style.transform = "scale(1)";
        }, 120);

        const c2 = lotteryState.config;
        if (outcome === "win") {
          resultText.textContent = c2.winText || "当たり！";
          playSafe(resultWinSound);
        } else {
          resultText.textContent = "ハズレ…";
          playSafe(resultLoseSound);
        }

        setTimeout(() => {
          ball.classList.remove("show");
          ball.classList.add("hide");
        }, 600);

        isSpinning = false;
        updateButtonsState();
      }, 1000);
    }

    gachaButtons.forEach((btn) => {
      btn.addEventListener("click", spinGacha);
    });
    undoButton.addEventListener("click", undoLastDraw);
    nextPersonButton.addEventListener("click", prepareForNextPerson);
    nextPartButton.addEventListener("click", () => {
      if (
        confirm(
          "次の部を開始し、カウントをリセットします。よろしいですか？"
        )
      ) {
        nextPart();
      }
    });
    detailsToggle.addEventListener("click", () => {
      const open = detailsPanel.classList.toggle("open");
      detailsToggle.textContent = open ? "詳細を隠す" : "詳細を表示";
    });

    // ===== 抽選設定 UI =====
    if (applyConfigButton) {
      applyConfigButton.addEventListener("click", () => {
        const totalTickets = parseInt(inputTotalTickets.value, 10);
        const totalWinsInput = parseInt(inputTotalWins.value, 10);
        const winText = inputWinText.value.trim() || "大当たり！";
        const titleText = inputTitle.value.trim() || "ローカルガチャ抽選機";

        if (isNaN(totalTickets) || totalTickets <= 0) {
          alert("総くじ数は1以上の整数で入力してください。");
          return;
        }
        if (isNaN(totalWinsInput) || totalWinsInput < 0) {
          alert("合計当たり本数は0以上の整数で入力してください。");
          return;
        }

        const rows = document.querySelectorAll(".image-setting-row");
        const prizes = [];
        let sumPrizeWins = 0;

        rows.forEach((row) => {
          const key = row.getAttribute("data-key");
          const labelInput = row.querySelector(".prize-label-input");
          const enabledEl = row.querySelector(".prize-enabled");
          const isWinEl = row.querySelector(".prize-is-win");
          const winCountInput = row.querySelector(".prize-win-count");

          const enabled = enabledEl ? enabledEl.checked : true;
          let isWin = isWinEl ? isWinEl.checked : false;
          let winCount = parseInt(winCountInput ? winCountInput.value : "0", 10);

          if (!enabled) {
            isWin = false;
            winCount = 0;
          }
          if (isNaN(winCount) || winCount < 0) {
            winCount = 0;
          }

          if (isWin && winCount > 0) {
            sumPrizeWins += winCount;
          } else {
            winCount = 0;
          }

          const labelRaw = labelInput ? labelInput.value : "";
          prizes.push({
            key,
            label: labelRaw && labelRaw.trim() !== "" ? labelRaw.trim() : key + "賞",
            defaultPath: key.toLowerCase() + ".png",
            enabled,
            isWin,
            winCountTotal: winCount,
          });
        });

        if (sumPrizeWins !== totalWinsInput) {
          alert(
            "各画像の当たり本数の合計 (" +
              sumPrizeWins +
              ") と、合計当たり本数 (" +
              totalWinsInput +
              ") が一致していません。"
          );
          return;
        }
        if (totalWinsInput > totalTickets) {
          alert("合計当たり本数は総くじ数以下にしてください。");
          return;
        }

        lotteryState.prizes = prizes;
        lotteryState.config.totalTickets = totalTickets;
        lotteryState.config.totalWins = totalWinsInput;
        lotteryState.config.title = titleText;
        lotteryState.config.winText = winText;

        resetStateForCurrentPart();
        saveLotteryState();
        updateConfigInputs();
        updateTitleDisplay();
      });
    }

    // 挑戦回数設定
    applySessionButton.addEventListener("click", () => {
      const v = inputSessionDraws.value.trim();
      if (v === "") {
        lotteryState.config.maxSessionDraw = null;
        lotteryState.state.sessionRemainingDraws = null;
      } else {
        const num = parseInt(v, 10);
        if (isNaN(num) || num <= 0) {
          alert("挑戦回数は1以上の整数で入力してください。");
          return;
        }
        lotteryState.config.maxSessionDraw = num;
        lotteryState.state.sessionRemainingDraws = num;
      }
      lotteryState.lastDraw = null;
      saveLotteryState();
      updateStatusDisplay();
      updateButtonsState();
    });

    // ===== 画像設定 UI =====
    function refreshImagePreviews() {
      const rows = document.querySelectorAll(".image-setting-row");
      rows.forEach((row) => {
        const key = row.getAttribute("data-key");
        const preview = row.querySelector(".image-preview");
        if (imageSources[key]) {
          preview.src = imageSources[key];
          preview.style.opacity = "1";
        } else {
          const defPath = key.toLowerCase() + ".png";
          preview.src = defPath;
          preview.style.opacity = "0.5";
        }
      });
    }

    function syncPrizeUIFromState() {
      const prizes = lotteryState.prizes || [];
      const rows = document.querySelectorAll(".image-setting-row");
      rows.forEach((row) => {
        const key = row.getAttribute("data-key");
        const prize = prizes.find((p) => p.key === key);
        const enabledEl = row.querySelector(".prize-enabled");
        const isWinEl = row.querySelector(".prize-is-win");
        const winCountInput = row.querySelector(".prize-win-count");
        const labelInput = row.querySelector(".prize-label-input");

        if (prize) {
          if (enabledEl) enabledEl.checked = !!prize.enabled;
          if (isWinEl) isWinEl.checked = !!prize.isWin;
          if (winCountInput)
            winCountInput.value =
              typeof prize.winCountTotal === "number"
                ? prize.winCountTotal
                : 0;
          if (labelInput)
            labelInput.value = prize.label || (prize.key + "賞");
        }
      });
    }

    function setupImageSettings() {
      const rows = document.querySelectorAll(".image-setting-row");
      rows.forEach((row) => {
        const key = row.getAttribute("data-key");
        const fileInput = row.querySelector('input[type="file"]');
        const clearBtn = row.querySelector(".clear-btn");

        fileInput.addEventListener("change", () => {
          const file = fileInput.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            imageSources[key] = e.target.result;
            saveImageSources();
            refreshImagePreviews();
          };
          reader.readAsDataURL(file);
        });

        clearBtn.addEventListener("click", () => {
          delete imageSources[key];
          saveImageSources();
          fileInput.value = "";
          refreshImagePreviews();
        });
      });

      refreshImagePreviews();
      syncPrizeUIFromState();
    }

    // ===== サウンド設定 UI =====
    function setupSoundSettings() {
      const rows = document.querySelectorAll(".sound-setting-row");
      rows.forEach((row) => {
        const key = row.getAttribute("data-sound-key");
        const fileInput = row.querySelector('input[type="file"]');
        const clearBtn = row.querySelector(".sound-clear-btn");

        fileInput.addEventListener("change", () => {
          const file = fileInput.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            soundSources[key] = e.target.result;
            saveSoundSources();

            if (key === "start") {
              startSound = createAudio(getSoundSrc("start", "roulette.mp3"));
            } else if (key === "resultWin") {
              resultWinSound = createAudio(
                getSoundSrc("resultWin", "atari.mp3")
              );
            } else if (key === "resultLose") {
              resultLoseSound = createAudio(
                getSoundSrc("resultLose", "hazure.mp3")
              );
            }
          };
          reader.readAsDataURL(file);
        });

        clearBtn.addEventListener("click", () => {
          delete soundSources[key];
          saveSoundSources();
          fileInput.value = "";

          if (key === "start") {
            startSound = createAudio(getSoundSrc("start", "roulette.mp3"));
          } else if (key === "resultWin") {
            resultWinSound = createAudio(
              getSoundSrc("resultWin", "atari.mp3")
            );
          } else if (key === "resultLose") {
            resultLoseSound = createAudio(
              getSoundSrc("resultLose", "hazure.mp3")
            );
          }
        });
      });

      startSound = createAudio(getSoundSrc("start", "roulette.mp3"));
      resultWinSound = createAudio(getSoundSrc("resultWin", "atari.mp3"));
      resultLoseSound = createAudio(getSoundSrc("resultLose", "hazure.mp3"));
    }

    setupImageSettings();
    setupSoundSettings();
  </script>

</body>
</html>
