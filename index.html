<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#ff9999" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="ガチャ抽選" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />
  <title>ローカルガチャ抽選機</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      width: 100%;
      overflow-x: hidden;
    }

    :root {
      --salmon: #ff9999;
      --salmon-deep: #d86868;
      --salmon-dark: #c85a5a;
      --salmon-accent: #ffb3b3;
      --salmon-light: #ffe1e1;
      --salmon-lighter: #fff2f2;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(
        circle at top,
        var(--salmon-lighter) 0%,
        var(--salmon-light) 45%,
        #fff 100%
      );
      color: #333;
      min-height: 100dvh;
      padding: 0;
      margin: 0;
    }

    .app {
      width: 100vw;
      margin: 0;
      text-align: center;
    }

    .first-view {
      min-height: 100dvh;
      padding: env(safe-area-inset-top)
        calc(env(safe-area-inset-right) + 12px) 8px
        calc(env(safe-area-inset-left) + 12px);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .below-fold {
      padding: 0 calc(env(safe-area-inset-right) + 12px) 16px
        calc(env(safe-area-inset-left) + 12px);
    }

    h1 {
      font-size: 1.5rem;
      margin: 6px 0 4px 0;
      color: var(--salmon-deep);
      letter-spacing: 0.3px;
      text-shadow: 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    .description {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 12px;
    }

    .machine {
      background: #ffffff;
      border-radius: 18px;
      padding: 10px;
      box-shadow: 0 10px 24px rgba(255, 153, 153, 0.25);
      position: relative;
      overflow: hidden;
    }

    .window {
      width: 100%;
      aspect-ratio: 1.5 / 1;
      background: linear-gradient(
        135deg,
        var(--salmon-lighter),
        var(--salmon-light)
      );
      border-radius: 16px;
      border: 2px solid var(--salmon-accent);
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      position: relative;
      margin-bottom: 6px;
    }

    .window img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      transition: opacity 0.2s ease-out, transform 0.2s ease-out;
    }

    .confetti {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 2;
    }

    .confetti-piece {
      position: absolute;
      top: -10%;
      left: 50%;
      width: 12px;
      height: 18px;
      border-radius: 4px;
      opacity: 0.9;
      transform: translate3d(var(--x, 0px), -20px, 0)
        rotate(var(--r, 0deg));
      animation: confettiFall var(--t, 1.6s) ease-out forwards;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }

    @keyframes confettiFall {
      0% {
        transform: translate3d(var(--x, 0px), -30px, 0)
          rotate(var(--r, 0deg));
        opacity: 0;
      }
      20% {
        opacity: 1;
      }
      100% {
        transform: translate3d(var(--x, 0px), var(--y, 360px), 0)
          rotate(calc(var(--r, 0deg) + 260deg));
        opacity: 0;
      }
    }

    .placeholder-text {
      position: absolute;
      font-size: 0.9rem;
      color: var(--salmon-dark);
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px dashed var(--salmon-accent);
    }


    .session-summary {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin: 12px 0 8px;
    }

    .summary-item {
      background: linear-gradient(
        135deg,
        var(--salmon-lighter),
        var(--salmon-light)
      );
      border-radius: 12px;
      padding: 8px;
      text-align: left;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7),
        0 6px 12px rgba(255, 153, 153, 0.2);
    }

    .summary-label {
      font-size: 1rem;
      color: var(--salmon-dark);
      margin-bottom: 2px;
    }

    .summary-value {
      font-size: 1.7rem;
      font-weight: 800;
      color: var(--salmon-deep);
    }

    .status-panel {
      display: grid;
      grid-template-columns: 1.3fr 1.7fr;
      gap: 6px 10px;
      font-size: 0.8rem;
      margin-bottom: 4px;
      text-align: left;
    }

    .status-label {
      color: #666;
    }

    .status-value {
      font-weight: 600;
    }

    .status-part {
      grid-column: 1 / -1;
      font-weight: 600;
      color: #444;
    }

    .status-breakdown {
      margin-top: 4px;
      font-size: 0.75rem;
      color: #555;
      text-align: left;
    }

    .gacha-controls {
      display: flex;
      flex-direction: column;
      gap: 28px;
      margin-top: 14px;
    }

    .gacha-primary {
      display: flex;
      flex-direction: column;
      gap: 22px;
    }

    .gacha-secondary {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .slot-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 22px;
      align-items: center;
    }

    .gacha-button {
      width: 100%;
      aspect-ratio: 1 / 1;
      padding: 0;
      border-radius: 999px;
      border: 3px solid var(--salmon-accent);
      font-size: 1.95rem;
      font-weight: 900;
      letter-spacing: 0.6px;
      font-family: "Avenir Next Rounded", "Hiragino Maru Gothic ProN",
        "Hiragino Sans", "Noto Sans JP", system-ui, sans-serif;
      background: radial-gradient(
        circle at 30% 28%,
        var(--salmon-lighter) 0%,
        var(--salmon-light) 35%,
        var(--salmon-accent) 70%,
        var(--salmon-deep) 100%
      );
      color: #ffffff;
      text-shadow: 0 2px 0 rgba(255, 255, 255, 0.2),
        0 4px 10px rgba(200, 90, 90, 0.45);
      box-shadow: 0 12px 20px rgba(255, 153, 153, 0.28),
        0 10px 18px rgba(220, 110, 110, 0.22),
        inset 0 10px 14px rgba(255, 255, 255, 0.7),
        inset 0 -12px 16px rgba(200, 90, 90, 0.25);
      cursor: pointer;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out,
        opacity 0.2s;
      position: relative;
      overflow: hidden;
    }

    .gacha-button::before {
      content: "";
      position: absolute;
      inset: 7%;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.65);
      box-shadow: inset 0 4px 10px rgba(255, 255, 255, 0.45),
        inset 0 -6px 12px rgba(180, 90, 120, 0.18);
      pointer-events: none;
    }

    .gacha-button::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 45%;
      background: radial-gradient(
        circle at 30% 10%,
        rgba(255, 255, 255, 0.9) 0%,
        rgba(255, 255, 255, 0.45) 40%,
        rgba(255, 255, 255, 0) 70%
      );
      pointer-events: none;
    }

    .gacha-button span {
      position: relative;
      z-index: 1;
      display: inline-block;
      padding: 10px 16px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.2);
      box-shadow: inset 0 2px 6px rgba(255, 255, 255, 0.4);
    }

    .gacha-button:active {
      transform: translateY(2px) scale(0.98);
      box-shadow: 0 8px 14px rgba(255, 153, 153, 0.24),
        0 3px 0 var(--salmon-dark),
        inset 0 6px 10px rgba(255, 255, 255, 0.4),
        inset 0 -10px 14px rgba(200, 90, 90, 0.3);
    }

    .gacha-button[disabled] {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .next-person-row {
      margin-top: auto;
      padding-top: 8px;
    }

    .next-person-button {
      width: 100%;
      padding: 12px;
      border-radius: 14px;
      border: none;
      font-size: 0.95rem;
      font-weight: 800;
      letter-spacing: 0.2px;
      background: linear-gradient(
        135deg,
        var(--salmon-light),
        var(--salmon-accent)
      );
      color: #7a2b2b;
      text-shadow: 0 1px 0 rgba(255, 255, 255, 0.6);
      box-shadow: 0 6px 12px rgba(255, 153, 153, 0.24),
        inset 0 1px 0 rgba(255, 255, 255, 0.75);
      cursor: pointer;
    }

    .session-inline {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 14px;
      background: var(--salmon-lighter);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6),
        0 4px 10px rgba(255, 153, 153, 0.14);
      font-size: 0.9rem;
    }

    .session-inline label {
      font-weight: 700;
      color: var(--salmon-deep);
      white-space: nowrap;
    }

    .session-inline input {
      width: 100%;
      font-size: 0.95rem;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--salmon-accent);
    }

    .session-inline button {
      padding: 8px 12px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(
        135deg,
        var(--salmon-light),
        var(--salmon-accent)
      );
      color: #7a2b2b;
      text-shadow: 0 1px 0 rgba(255, 255, 255, 0.6);
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 3px 8px rgba(255, 153, 153, 0.24);
    }

    .sub-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    .sub-buttons button {
      flex: 1 1 30%;
      padding: 6px 8px;
      border-radius: 999px;
      border: none;
      font-size: 0.75rem;
      background: linear-gradient(
        135deg,
        var(--salmon-lighter),
        var(--salmon-light)
      );
      color: #7a2b2b;
      cursor: pointer;
    }

    .sub-buttons button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .result-text {
      margin: 16px auto 0;
      font-size: 2.35rem;
      font-weight: 900;
      min-height: 1.8em;
      padding: 6px 14px;
      border-radius: 999px;
      background: transparent;
      color: var(--salmon-deep);
      text-shadow: 0 1px 0 rgba(255, 255, 255, 0.7),
        0 3px 10px rgba(200, 90, 90, 0.25);
      width: fit-content;
    }

    .result-text.is-win {
      background: transparent;
      color: #d84315;
      text-shadow: 0 1px 0 rgba(255, 255, 255, 0.7),
        0 6px 16px rgba(255, 140, 80, 0.35);
      animation: cheerPop 0.8s ease-out, cheerPulse 1.6s ease-out;
    }

    .result-text.is-lose {
      background: transparent;
      color: #2c4a7a;
      animation: none;
    }

    @keyframes cheerPop {
      0% {
        transform: translateY(10px) scale(0.88);
        opacity: 0.5;
      }
      60% {
        transform: translateY(-8px) scale(1.12);
        opacity: 1;
      }
      100% {
        transform: translateY(0) scale(1);
      }
    }

    @keyframes cheerGlow {
      0% {
        box-shadow: 0 0 0 rgba(255, 200, 120, 0);
      }
      70% {
        box-shadow: 0 0 46px rgba(255, 200, 120, 0.8);
      }
      100% {
        box-shadow: 0 0 0 rgba(255, 200, 120, 0);
      }
    }

    .gacha-button.is-win {
      animation: buttonAura 1.8s ease-out;
      box-shadow: 0 12px 20px rgba(230, 120, 160, 0.22),
        0 0 28px rgba(255, 210, 120, 0.7),
        0 0 46px rgba(255, 210, 120, 0.45),
        inset 0 10px 14px rgba(255, 255, 255, 0.7),
        inset 0 -12px 16px rgba(180, 80, 120, 0.22);
    }

    @keyframes buttonAura {
      0% {
        box-shadow: 0 12px 20px rgba(230, 120, 160, 0.22),
          0 0 0 rgba(255, 210, 120, 0),
          0 0 0 rgba(255, 210, 120, 0),
          inset 0 10px 14px rgba(255, 255, 255, 0.7),
          inset 0 -12px 16px rgba(180, 80, 120, 0.22);
      }
      60% {
        box-shadow: 0 12px 20px rgba(230, 120, 160, 0.22),
          0 0 36px rgba(255, 210, 120, 0.85),
          0 0 64px rgba(255, 210, 120, 0.55),
          inset 0 10px 14px rgba(255, 255, 255, 0.7),
          inset 0 -12px 16px rgba(180, 80, 120, 0.22);
      }
      100% {
        box-shadow: 0 12px 20px rgba(230, 120, 160, 0.22),
          0 0 0 rgba(255, 210, 120, 0),
          0 0 0 rgba(255, 210, 120, 0),
          inset 0 10px 14px rgba(255, 255, 255, 0.7),
          inset 0 -12px 16px rgba(180, 80, 120, 0.22);
      }
    }

    @keyframes cheerPulse {
      0% {
        filter: brightness(1);
      }
      50% {
        filter: brightness(1.15);
      }
      100% {
        filter: brightness(1);
      }
    }


    .details-toggle-row {
      margin-top: 12px;
      text-align: center;
    }

    .details-toggle-row button {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 0.95rem;
      background: linear-gradient(
        135deg,
        var(--salmon-lighter),
        var(--salmon-light)
      );
      color: #7a2b2b;
      cursor: pointer;
    }

    .details-panel {
      display: none;
      margin-top: 10px;
      background: var(--salmon-lighter);
      border-radius: 14px;
      padding: 12px 14px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    .details-panel.open {
      display: block;
    }

    .settings-link {
      margin-top: 16px;
      text-align: center;
    }

    .settings-link a {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 10px;
      background: linear-gradient(
        135deg,
        var(--salmon-lighter),
        var(--salmon-light)
      );
      color: #7a2b2b;
      text-decoration: none;
      font-weight: 700;
    }

    .footer {
      margin-top: 10px;
      font-size: 0.75rem;
      color: #999;
      text-align: left;
    }

    .settings {
      margin-top: 18px;
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
      text-align: left;
      font-size: 0.8rem;
    }

    .settings h2 {
      font-size: 0.95rem;
      margin-bottom: 6px;
    }

    .settings .note {
      color: #777;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .settings .env {
      font-size: 0.74rem;
      color: #999;
      margin-bottom: 6px;
    }

    .settings-section-title {
      margin-top: 10px;
      margin-bottom: 4px;
      font-size: 0.88rem;
      font-weight: 600;
    }

    .settings-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .settings-row label {
      min-width: 90px;
      font-size: 0.78rem;
      color: #555;
    }

    .settings-row input[type="number"],
    .settings-row input[type="text"] {
      flex: 1;
      font-size: 0.8rem;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      min-width: 0;
    }

    .settings-row button.settings-main-btn {
      flex: 1;
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      background: var(--salmon);
      color: #fff;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .image-setting-row,
    .sound-setting-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .image-setting-row span.key-label,
    .sound-setting-row span.key-label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: #eee;
      font-size: 0.8rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    .image-preview {
      width: 28px;
      height: 28px;
      border-radius: 4px;
      object-fit: cover;
      border: 1px solid #ddd;
      flex-shrink: 0;
    }

    .small-label {
      font-size: 0.7rem;
      white-space: nowrap;
    }

    .prize-label-input {
      flex: 1;
      min-width: 80px;
      font-size: 0.75rem;
      padding: 3px 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .prize-win-count {
      width: 56px;
      font-size: 0.7rem;
      padding: 3px 4px;
    }

    .sound-label-text {
      min-width: 80px;
      font-size: 0.75rem;
    }

    .image-setting-row input[type="file"],
    .sound-setting-row input[type="file"] {
      flex: 1;
      font-size: 0.72rem;
    }

    .image-setting-row button,
    .sound-setting-row button {
      border: none;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 0.7rem;
      background: #eee;
      cursor: pointer;
      flex-shrink: 0;
    }

    .settings-footer {
      margin-top: 4px;
      font-size: 0.7rem;
      color: #aaa;
    }

    @media (max-width: 820px) {
      .app {
        width: 100vw;
      }
      .slot-buttons {
        gap: 24px;
      }
      .summary-label {
        font-size: 1rem;
      }
      .summary-value {
        font-size: 1.7rem;
      }
      .result-text {
        font-size: 2.2rem;
      }
    }

    @media (min-width: 768px) and (max-width: 1024px) {
      .first-view {
        height: 100dvh;
        overflow: hidden;
        padding: calc(env(safe-area-inset-top) + 4px)
          calc(env(safe-area-inset-right) + 14px) 8px
          calc(env(safe-area-inset-left) + 14px);
      }
      h1 {
        font-size: 1.22rem;
        margin: 4px 0 2px;
      }
      .description {
        margin-bottom: 4px;
      }
      .machine {
        padding: 8px;
      }
      .window {
        aspect-ratio: 1.55 / 1;
      }
      .gacha-controls {
        margin-top: 10px;
        gap: 24px;
      }
      .gacha-primary {
        gap: 18px;
      }
      .slot-buttons {
        gap: 18px;
      }
      .summary-item {
        padding: 6px;
      }
      .summary-label {
        font-size: 0.98rem;
      }
      .summary-value {
        font-size: 1.6rem;
      }
      .gacha-button {
        font-size: 1.55rem;
      }
      .result-text {
        margin-top: 8px;
        font-size: 2rem;
      }
      .next-person-button {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="first-view">
      <h1 id="app-title">ローカルガチャ抽選機</h1>

      <div class="machine">
      <div class="window">
        <img id="result-image" src="" alt="ガチャ結果" style="opacity: 0" />
        <div id="placeholder-text" class="placeholder-text">
          ボタンを押してスタート
        </div>
      </div>
      <div id="confetti" class="confetti" aria-hidden="true"></div>

        <div class="gacha-controls">
          <div class="gacha-primary">
            <div class="slot-buttons" role="group" aria-label="ガチャボタン">
              <button class="gacha-button" type="button"><span>PUSH!</span></button>
              <button class="gacha-button" type="button"><span>PUSH!</span></button>
              <button class="gacha-button" type="button"><span>PUSH!</span></button>
            </div>
            <div id="result-text" class="result-text"></div>
          </div>
        </div>

        <div class="session-summary" aria-label="今回のサマリー">
          <div class="summary-item">
            <div class="summary-label">抽選回数</div>
            <div class="summary-value" id="summary-drawn-count">0回</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">当たり</div>
            <div class="summary-value" id="summary-win-count">0回</div>
          </div>
        </div>
      </div>

      <div class="next-person-row">
        <button id="next-person-button" class="next-person-button" type="button">
          次の人へ
        </button>
      </div>
    </div>

    <div class="below-fold">
      <div class="gacha-controls gacha-secondary">
        <div class="session-inline">
          <label for="input-session-draws">今回の挑戦回数</label>
          <input
            id="input-session-draws"
            type="number"
            min="1"
            step="1"
            placeholder="例: 3"
          />
          <button id="apply-session-button" type="button">セット</button>
        </div>

        <div class="sub-buttons">
          <button id="undo-button" type="button">1回戻す</button>
          <button id="next-part-button" type="button">次の部へ</button>
        </div>
      </div>

      <div class="details-toggle-row">
        <button id="details-toggle" type="button">詳細を表示</button>
      </div>
      <div id="details-panel" class="details-panel" aria-live="polite">
        <div class="status-panel">
          <div class="status-part" id="status-part"></div>

          <div class="status-label">残り当たり</div>
          <div class="status-value" id="status-remaining-wins"></div>

          <div class="status-label">残りくじ</div>
          <div class="status-value" id="status-remaining-tickets"></div>

          <div class="status-label">試行数</div>
          <div class="status-value" id="status-drawn-count"></div>

          <div class="status-label">当たり回数</div>
          <div class="status-value" id="status-win-count"></div>

          <div class="status-label">今回残り回数</div>
          <div class="status-value" id="status-session-draws"></div>
        </div>
        <div id="status-win-breakdown" class="status-breakdown"></div>
      </div>

      <div class="settings-link">
        <a href="settings.html">設定ページを開く</a>
      </div>
    </div>
  </div>

  <script>
    const PRIZE_KEYS = ["A", "B", "C", "D", "E"];

    // Register Service Worker for PWA install/offline on iPad and other devices.
    const enableServiceWorker =
      "serviceWorker" in navigator &&
      (window.isSecureContext ||
        location.protocol === "https:" ||
        location.hostname === "localhost" ||
        location.hostname === "127.0.0.1");

    if (enableServiceWorker) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("./sw.js")
          .catch((err) =>
            console.warn("Service Worker registration failed:", err)
          );
      });
    }

    // ===== 画像ソース管理 =====
    const IMAGE_STORAGE_KEY = "gachaImageSourcesV1";
    let imageSources = {};

    function loadImageSources() {
      try {
        try {
          localStorage.removeItem(IMAGE_STORAGE_KEY);
        } catch (e) {}
        const raw = localStorage.getItem(IMAGE_STORAGE_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === "object") {
            imageSources = parsed;
          }
        }
      } catch (e) {
        imageSources = {};
      }
    }

    function saveImageSources() {
      try {
        localStorage.setItem(IMAGE_STORAGE_KEY, JSON.stringify(imageSources));
      } catch (e) {}
    }

    function getImageSrc(key, defaultPath) {
      if (imageSources && imageSources[key]) {
        return imageSources[key];
      }
      return defaultPath;
    }

    loadImageSources();

    // ===== サウンドソース管理 =====
    const SOUND_STORAGE_KEY = "gachaSoundSourcesV1";
    let soundSources = {};

    function loadSoundSources() {
      try {
        try {
          localStorage.removeItem(SOUND_STORAGE_KEY);
        } catch (e) {}
        const raw = localStorage.getItem(SOUND_STORAGE_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === "object") {
            soundSources = parsed;
          }
        }
      } catch (e) {
        soundSources = {};
      }
    }

    function saveSoundSources() {
      try {
        localStorage.setItem(SOUND_STORAGE_KEY, JSON.stringify(soundSources));
      } catch (e) {}
    }

    function getSoundSrc(key, defaultPath) {
      if (soundSources && soundSources[key]) {
        return soundSources[key];
      }
      return defaultPath;
    }

    loadSoundSources();

    function createAudio(src) {
      const audio = new Audio(src);
      audio.preload = "auto";
      audio.playsInline = true;
      return audio;
    }

    let startSound = createAudio(getSoundSrc("start", "roulette.mp3"));
    let resultWinSound = createAudio(getSoundSrc("resultWin", "atari.mp3"));
    let resultLoseSound = createAudio(getSoundSrc("resultLose", "hazure.mp3"));

    // Unlock audio on iOS/WKWebView which blocks playback until a user gesture.
    const audioUnlockEvents = ["pointerdown", "touchstart", "click", "keydown"];
    let audioUnlocked = false;

    function unlockAudio() {
      if (audioUnlocked) return;
      audioUnlocked = true;

      try {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (AudioCtx) {
          const ctx = new AudioCtx();
          ctx.resume().catch(() => {});
        }
      } catch (e) {}

      [startSound, resultWinSound, resultLoseSound].forEach((audio) => {
        if (!audio) return;
        try {
          audio.muted = true;
          const p = audio.play();
          if (p && typeof p.catch === "function") {
            p.catch(() => {});
          }
          audio.pause();
          audio.currentTime = 0;
          audio.muted = false;
        } catch (e) {}
      });

      audioUnlockEvents.forEach((ev) =>
        document.removeEventListener(ev, unlockAudio, true)
      );
    }

    audioUnlockEvents.forEach((ev) =>
      document.addEventListener(ev, unlockAudio, {
        capture: true,
        passive: true,
      })
    );

    async function playSafe(audio, limitMs) {
      if (!audio) return;
      try {
        audio.currentTime = 0;
        const p = audio.play();
        if (limitMs && limitMs > 0) {
          setTimeout(() => {
            try {
              audio.pause();
              audio.currentTime = 0;
            } catch (e) {}
          }, limitMs);
        }
        await p;
      } catch (e) {
        console.warn("サウンド再生に失敗しました:", e);
      }
    }

    // ===== 抽選ロジック用状態管理 =====
    const LOTTERY_STORAGE_KEY = "gachaLotteryStateV6";
    const LEGACY_LOTTERY_KEYS = [
      "gachaLotteryStateV5",
      "gachaLotteryStateV4",
      "gachaLotteryStateV3",
      "gachaLotteryStateV2",
    ];

    let lotteryState = {
      version: 6,
      currentPart: 1,
      config: {
        totalTickets: 330,
        totalWins: 10,
        title: "Boosty Winter Party 2026",
        winText: "おめでとうございます！",
        maxSessionDraw: null, // ★ 初期は上限なし
      },
      prizes: [],
      state: {
        drawnCount: 0,
        winCount: 0,
        personDrawnCount: 0,
        personWinCount: 0,
        remainingTickets: 100,
        remainingWins: 10,
        prizeRemainingWins: {},
        sessionRemainingDraws: null, // ★ 初期は上限なし
      },
      lastDraw: null, // {outcome, prizeKey}
    };

    function loadLotteryState() {
      try {
        let raw = localStorage.getItem(LOTTERY_STORAGE_KEY);
        let loadedFromLegacy = false;

        if (!raw) {
          for (const key of LEGACY_LOTTERY_KEYS) {
            raw = localStorage.getItem(key);
            if (raw) {
              loadedFromLegacy = true;
              break;
            }
          }
        }

        if (raw) {
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === "object" && parsed.config && parsed.state) {
            lotteryState = parsed;
            if (loadedFromLegacy) {
              saveLotteryState();
              LEGACY_LOTTERY_KEYS.forEach((key) => {
                try {
                  localStorage.removeItem(key);
                } catch (e) {}
              });
            }
          }
        }
      } catch (e) {
        // ignore
      }
    }

    function saveLotteryState() {
      try {
        localStorage.setItem(LOTTERY_STORAGE_KEY, JSON.stringify(lotteryState));
      } catch (e) {}
    }

    function ensurePrizesInitialized() {
      if (!Array.isArray(lotteryState.prizes)) {
        lotteryState.prizes = [];
      }

      const existingKeys = new Set(lotteryState.prizes.map((p) => p.key));

      // 初回は A だけ当たり10本、Bは有効だが当たりなし、C〜Eは無効
      PRIZE_KEYS.forEach((key) => {
        if (!existingKeys.has(key)) {
          lotteryState.prizes.push({
            key,
            label:
              key === "A" ? "当選" : key === "B" ? "落選" : key + "賞",
            defaultPath: key.toLowerCase() + ".png",
            enabled: key === "A" || key === "B",
            isWin: key === "A",
            winCountTotal: key === "A" ? 10 : 0,
          });
        }
      });

      // config の整合性
      const sumWins =
        lotteryState.prizes.reduce(
          (acc, p) =>
            acc + (p.enabled && p.isWin ? (p.winCountTotal || 0) : 0),
          0
        ) || 0;

      if (
        !lotteryState.config ||
        typeof lotteryState.config.totalTickets !== "number" ||
        lotteryState.config.totalTickets <= 0
      ) {
        lotteryState.config = {
          totalTickets: Math.max(sumWins || 330, 1),
          totalWins: sumWins || 10,
          title: "Boosty Winter Party 2026",
          winText: "おめでとうございます！",
          maxSessionDraw: null, // ★ 初期は上限なし
        };
      } else {
        lotteryState.config.totalWins = sumWins;
        if (!("maxSessionDraw" in lotteryState.config)) {
          lotteryState.config.maxSessionDraw = null;
        }
        if (!("title" in lotteryState.config)) {
          lotteryState.config.title = "Boosty Winter Party 2026";
        }
        if (!("winText" in lotteryState.config)) {
          lotteryState.config.winText = "おめでとうございます！";
        }
      }

      if (!lotteryState.state || typeof lotteryState.state !== "object") {
        lotteryState.state = {
          drawnCount: 0,
          winCount: 0,
          personDrawnCount: 0,
          personWinCount: 0,
          remainingTickets: lotteryState.config.totalTickets,
          remainingWins: sumWins,
          prizeRemainingWins: {},
          sessionRemainingDraws:
            lotteryState.config.maxSessionDraw != null
              ? lotteryState.config.maxSessionDraw
              : null,
        };
      }

      if (!lotteryState.state.prizeRemainingWins) {
        lotteryState.state.prizeRemainingWins = {};
        let remWins = 0;
        lotteryState.prizes.forEach((p) => {
          const w = p.enabled && p.isWin ? (p.winCountTotal || 0) : 0;
          lotteryState.state.prizeRemainingWins[p.key] = w;
          remWins += w;
        });
        lotteryState.state.remainingWins = remWins;
      }

      if (!("personDrawnCount" in lotteryState.state)) {
        lotteryState.state.personDrawnCount = 0;
      }
      if (!("personWinCount" in lotteryState.state)) {
        lotteryState.state.personWinCount = 0;
      }

      if (
        lotteryState.config.maxSessionDraw != null &&
        (lotteryState.state.sessionRemainingDraws == null ||
          lotteryState.state.sessionRemainingDraws >
            lotteryState.config.maxSessionDraw)
      ) {
        lotteryState.state.sessionRemainingDraws =
          lotteryState.config.maxSessionDraw;
      }

      saveLotteryState();
    }

    loadLotteryState();
    ensurePrizesInitialized();

    // ===== DOM 取得 =====
    const appTitle = document.getElementById("app-title");
    const resultImage = document.getElementById("result-image");
    const placeholderText = document.getElementById("placeholder-text");
    const gachaButtons = Array.from(document.querySelectorAll(".gacha-button"));
    const undoButton = document.getElementById("undo-button");
    const nextPersonButton = document.getElementById("next-person-button");
    const nextPartButton = document.getElementById("next-part-button");
    const resultText = document.getElementById("result-text");

    const statusPart = document.getElementById("status-part");
    const statusRemainingWins = document.getElementById(
      "status-remaining-wins"
    );
    const statusRemainingTickets = document.getElementById(
      "status-remaining-tickets"
    );
    const statusDrawnCount = document.getElementById("status-drawn-count");
    const statusWinCount = document.getElementById("status-win-count");
    const statusSessionDraws = document.getElementById("status-session-draws");
    const statusWinBreakdown = document.getElementById("status-win-breakdown");
    const summaryDrawnCount = document.getElementById("summary-drawn-count");
    const summaryWinCount = document.getElementById("summary-win-count");
    const detailsToggle = document.getElementById("details-toggle");
    const detailsPanel = document.getElementById("details-panel");
    const confetti = document.getElementById("confetti");

    const inputTitle = document.getElementById("input-title");
    const inputTotalTickets = document.getElementById("input-total-tickets");
    const inputTotalWins = document.getElementById("input-total-wins");
    const inputWinText = document.getElementById("input-win-text");
    const inputSessionDraws = document.getElementById("input-session-draws");
    const applyConfigButton = document.getElementById("apply-config-button");
    const applySessionButton = document.getElementById("apply-session-button");
    const envInfo = document.getElementById("env-info");

    resultImage.addEventListener("error", () => {
      console.warn("画像を読み込めませんでした:", resultImage.src);
    });

    try {
      const href = location.href || "";
      if (envInfo) {
        if (href.startsWith("content://")) {
          envInfo.textContent =
            "現在のURL: content:// ... （ローカルファイル・コンテンツ経由）";
        } else if (href.startsWith("file://")) {
          envInfo.textContent = "現在のURL: file:// ... （ローカルファイル）";
        } else if (href.startsWith("http")) {
          envInfo.textContent = "現在のURL: " + href.split("#")[0];
        }
      }
    } catch (e) {
      if (envInfo) envInfo.textContent = "";
    }

    let isSpinning = false;

    function launchConfetti() {
      if (!confetti) return;
      confetti.innerHTML = "";
      const colors = [
        "#ffd166",
        "#ff8fab",
        "#8ecae6",
        "#cdb4db",
        "#b9fbc0",
        "#fcbf49",
        "#ff6b6b",
      ];
      const count = 36;
      for (let i = 0; i < count; i += 1) {
        const piece = document.createElement("span");
        piece.className = "confetti-piece";
        const x = (Math.random() - 0.5) * 320;
        const y = 260 + Math.random() * 300;
        const r = Math.floor(Math.random() * 360);
        const t = 1.1 + Math.random() * 0.9;
        piece.style.setProperty("--x", `${x}px`);
        piece.style.setProperty("--y", `${y}px`);
        piece.style.setProperty("--r", `${r}deg`);
        piece.style.setProperty("--t", `${t}s`);
        piece.style.background = colors[i % colors.length];
        piece.style.left = `${20 + Math.random() * 60}%`;
        confetti.appendChild(piece);
      }
      setTimeout(() => {
        if (confetti) confetti.innerHTML = "";
      }, 2200);
    }

    // ===== 表示更新系 =====
    function getPrizeLabel(prize) {
      if (prize && prize.label && prize.label.trim() !== "") {
        return prize.label.trim();
      }
      return prize ? prize.key + "賞" : "";
    }

    function ensureUnlimitedWhenUnset() {
      if (!inputSessionDraws) return;
      const raw = inputSessionDraws.value.trim();
      if (raw !== "") return;
      const c = lotteryState.config;
      const s = lotteryState.state;
      if (c.maxSessionDraw != null || s.sessionRemainingDraws != null) {
        c.maxSessionDraw = null;
        s.sessionRemainingDraws = null;
        saveLotteryState();
      }
    }

    function isSessionLimited() {
      const c = lotteryState.config;
      if (c.maxSessionDraw == null) return false;
      if (!inputSessionDraws) return true;
      const raw = inputSessionDraws.value.trim();
      if (raw === "") return false;
      const num = Number(raw);
      return Number.isFinite(num) && num > 0;
    }

    function updateStatusDisplay() {
      ensureUnlimitedWhenUnset();
      const c = lotteryState.config;
      const s = lotteryState.state;
      statusPart.textContent = `現在の部：第 ${lotteryState.currentPart} 部`;
      statusRemainingWins.textContent = `${s.remainingWins} 本 / ${c.totalWins} 本`;
      statusRemainingTickets.textContent = `${s.remainingTickets} 枚 / ${c.totalTickets} 枚`;
      statusDrawnCount.textContent = `${s.drawnCount} 回`;
      statusWinCount.textContent = `${s.winCount} 回`;
      summaryDrawnCount.textContent = `${s.personDrawnCount || 0} 回`;
      summaryWinCount.textContent = `${s.personWinCount || 0} 回`;

      if (!isSessionLimited()) {
        statusSessionDraws.textContent = "無制限";
      } else {
        const rem = s.sessionRemainingDraws != null ? s.sessionRemainingDraws : 0;
        statusSessionDraws.textContent = `${rem} 回 / ${c.maxSessionDraw} 回`;
      }

      const prizes = lotteryState.prizes || [];
      const breakdownItems = [];
      prizes.forEach((p) => {
        if (!p.enabled || !p.isWin || !(p.winCountTotal > 0)) return;
        const rem =
          s.prizeRemainingWins && typeof s.prizeRemainingWins[p.key] === "number"
            ? s.prizeRemainingWins[p.key]
            : 0;
        const label = getPrizeLabel(p);
        breakdownItems.push(
          `${label}: 残り${rem}本 / 全${p.winCountTotal}本`
        );
      });
      if (breakdownItems.length === 0) {
        statusWinBreakdown.textContent = "残り当たり内訳: （設定されていません）";
      } else {
        statusWinBreakdown.textContent =
          "残り当たり内訳: " + breakdownItems.join(" ／ ");
      }
    }

    function updateTitleDisplay() {
      if (!appTitle) return;
      appTitle.textContent =
        (lotteryState.config && lotteryState.config.title) ||
        "ローカルガチャ抽選機";
    }

    function clearResultDisplay() {
      resultText.textContent = "";
      resultText.classList.remove("is-win", "is-lose");
      if (lotteryState.state.drawnCount === 0) {
        placeholderText.style.display = "block";
        resultImage.style.visibility = "hidden";
        resultImage.style.opacity = 0;
      }
    }

    function updateConfigInputs() {
      const c = lotteryState.config;
      if (inputTitle) inputTitle.value = c.title || "ローカルガチャ抽選機";
      if (inputTotalTickets) inputTotalTickets.value = c.totalTickets;
      if (inputTotalWins) inputTotalWins.value = c.totalWins;
      if (inputWinText) inputWinText.value = c.winText || "";
      if (inputSessionDraws) {
        if (c.maxSessionDraw != null) {
          inputSessionDraws.value = c.maxSessionDraw;
        } else {
          inputSessionDraws.value = "";
        }
      }
    }

    function updateButtonsState() {
      ensureUnlimitedWhenUnset();
      const s = lotteryState.state;
      const sessionLimited = isSessionLimited();
      const sessionBlocked =
        sessionLimited &&
        s.sessionRemainingDraws != null &&
        s.sessionRemainingDraws <= 0;
      undoButton.disabled = !lotteryState.lastDraw;
      const gachaDisabled =
        s.remainingTickets <= 0 || isSpinning || sessionBlocked;
      gachaButtons.forEach((btn) => {
        btn.disabled = gachaDisabled;
        btn.classList.remove("is-win");
      });
    }

    updateStatusDisplay();
    updateConfigInputs();
    updateTitleDisplay();
    updateButtonsState();

    // ===== 抽選ロジック =====
    function resetStateForCurrentPart() {
      const c = lotteryState.config;
      const prizes = lotteryState.prizes;
      const prizeRemainingWins = {};
      let totalWins = 0;
      prizes.forEach((p) => {
        const w = p.enabled && p.isWin ? (p.winCountTotal || 0) : 0;
        prizeRemainingWins[p.key] = w;
        totalWins += w;
      });
      lotteryState.config.totalWins = totalWins;
      lotteryState.state = {
        drawnCount: 0,
        winCount: 0,
        personDrawnCount: 0,
        personWinCount: 0,
        remainingTickets: c.totalTickets,
        remainingWins: totalWins,
        prizeRemainingWins,
        sessionRemainingDraws:
          c.maxSessionDraw != null ? c.maxSessionDraw : null,
      };
      lotteryState.lastDraw = null;
      saveLotteryState();
      updateStatusDisplay();
      updateButtonsState();
      updateConfigInputs();
      clearResultDisplay();
    }

    function prepareForNextPerson() {
      const c = lotteryState.config;
      const s = lotteryState.state;

      s.sessionRemainingDraws =
        c.maxSessionDraw != null ? c.maxSessionDraw : null;
      s.personDrawnCount = 0;
      s.personWinCount = 0;

      lotteryState.lastDraw = null;
      saveLotteryState();
      updateStatusDisplay();
      updateButtonsState();
      placeholderText.style.display = "block";
      resultImage.style.visibility = "hidden";
      resultImage.style.opacity = 0;
      resultText.textContent = "";
      resultText.classList.remove("is-win", "is-lose");
      resultSub.textContent = "";
      if (inputSessionDraws) {
        inputSessionDraws.value = "";
      }
    }

    function nextPart() {
      lotteryState.currentPart += 1;
      resetStateForCurrentPart();
    }

    function performDraw() {
      ensureUnlimitedWhenUnset();
      const s = lotteryState.state;
      const c = lotteryState.config;
      const prizes = lotteryState.prizes;

      if (s.remainingTickets <= 0) {
        resultText.textContent = "くじはすべて引き終わりました。";
        resultSub.textContent = "";
        return null;
      }

      const sessionLimited = isSessionLimited();
      if (
        sessionLimited &&
        s.sessionRemainingDraws != null &&
        s.sessionRemainingDraws <= 0
      ) {
        resultText.textContent = "今回の挑戦回数は終了しました。";
        resultSub.textContent =
          "設定から次の挑戦回数を入力してください。";
        return null;
      }

      const R = s.remainingTickets;
      const W = s.remainingWins || 0;

      let outcome = "lose";
      let prizeKey = null;

      if (W > 0) {
        const r = Math.random() * R;
        if (r < W) {
          outcome = "win";
        }
      }

      s.drawnCount += 1;
      s.personDrawnCount = (s.personDrawnCount || 0) + 1;
      s.remainingTickets -= 1;

      if (c.maxSessionDraw != null && s.sessionRemainingDraws != null) {
        s.sessionRemainingDraws = Math.max(
          0,
          s.sessionRemainingDraws - 1
        );
      }

      if (outcome === "win") {
        const winPrizes = prizes.filter(
          (p) =>
            p.enabled &&
            p.isWin &&
            s.prizeRemainingWins &&
            s.prizeRemainingWins[p.key] > 0
        );
        if (winPrizes.length === 0) {
          outcome = "lose";
        } else {
          let totalRemWins = 0;
          winPrizes.forEach((p) => {
            totalRemWins += s.prizeRemainingWins[p.key];
          });
          let rnd = Math.random() * totalRemWins;
          let chosen = winPrizes[0];
          for (const p of winPrizes) {
            const w = s.prizeRemainingWins[p.key];
            if (rnd < w) {
              chosen = p;
              break;
            }
            rnd -= w;
          }
          prizeKey = chosen.key;
          s.prizeRemainingWins[prizeKey] -= 1;
          s.remainingWins -= 1;
          s.winCount += 1;
          s.personWinCount = (s.personWinCount || 0) + 1;
        }
      }

      if (outcome === "lose") {
        const losePrizes = prizes.filter((p) => p.enabled && !p.isWin);
        if (losePrizes.length > 0) {
          const idx = Math.floor(Math.random() * losePrizes.length);
          prizeKey = losePrizes[idx].key;
        } else {
          prizeKey = null;
        }
      }

      lotteryState.lastDraw = { outcome, prizeKey };
      saveLotteryState();
      updateStatusDisplay();
      updateButtonsState();

      return { outcome, prizeKey };
    }

    function undoLastDraw() {
      const last = lotteryState.lastDraw;
      if (!last) return;
      const s = lotteryState.state;
      const c = lotteryState.config;
      if (s.drawnCount <= 0) {
        lotteryState.lastDraw = null;
        updateButtonsState();
        return;
      }

      s.drawnCount -= 1;
      if (s.personDrawnCount && s.personDrawnCount > 0) {
        s.personDrawnCount -= 1;
      }
      s.remainingTickets += 1;

      if (c.maxSessionDraw != null) {
        if (s.sessionRemainingDraws == null) {
          s.sessionRemainingDraws = 1;
        } else {
          s.sessionRemainingDraws += 1;
          if (s.sessionRemainingDraws > c.maxSessionDraw) {
            s.sessionRemainingDraws = c.maxSessionDraw;
          }
        }
      }

      if (last.outcome === "win") {
        s.winCount -= 1;
        if (s.personWinCount && s.personWinCount > 0) {
          s.personWinCount -= 1;
        }
        s.remainingWins += 1;
        if (
          last.prizeKey &&
          s.prizeRemainingWins &&
          typeof s.prizeRemainingWins[last.prizeKey] === "number"
        ) {
          s.prizeRemainingWins[last.prizeKey] += 1;
        }
      }

      lotteryState.lastDraw = null;
      saveLotteryState();
      updateStatusDisplay();
      updateButtonsState();

      if (s.drawnCount === 0) {
        placeholderText.style.display = "block";
        resultImage.style.visibility = "hidden";
        resultImage.style.opacity = 0;
        resultText.textContent = "";
        resultText.classList.remove("is-win", "is-lose");
      }
    }

    function getFinalImageForOutcome(outcome, prizeKey) {
      if (prizeKey) {
        const defPath = prizeKey.toLowerCase() + ".png";
        return getImageSrc(prizeKey, defPath);
      }
      if (outcome === "win") {
        return getImageSrc("A", "a.png");
      }
      return getImageSrc("E", "e.png");
    }

    function getEnabledPrizeKeys() {
      const prizes = lotteryState.prizes || [];
      return prizes.filter((p) => p.enabled).map((p) => p.key);
    }

    const SPIN_INTERVAL_MS = 25;
    const SPIN_DURATION_MS = 220;
    const START_SOUND_LIMIT_MS = 500;

    function spinGacha() {
      ensureUnlimitedWhenUnset();
      const s = lotteryState.state;
      const c = lotteryState.config;
      const sessionLimited = isSessionLimited();
      const sessionBlocked =
        sessionLimited &&
        s.sessionRemainingDraws != null &&
        s.sessionRemainingDraws <= 0;

      if (isSpinning || s.remainingTickets <= 0 || sessionBlocked) {
        if (sessionBlocked) {
          resultText.textContent = "今回の挑戦回数は終了しました。";
        }
        return;
      }

      isSpinning = true;
      updateButtonsState();

      resultText.textContent = "抽選中...";
      resultText.classList.remove("is-win", "is-lose");
      placeholderText.style.display = "none";
      gachaButtons.forEach((btn) => btn.classList.remove("is-win"));

      playSafe(startSound, START_SOUND_LIMIT_MS);


      setTimeout(() => {

        const drawResult = performDraw();
        if (!drawResult) {
          isSpinning = false;
          updateButtonsState();
          return;
        }

        const { outcome, prizeKey } = drawResult;
        const finalImageSrc = getFinalImageForOutcome(outcome, prizeKey);
        resultImage.src = finalImageSrc;
        resultImage.style.visibility = "visible";
        resultImage.style.opacity = 1;
        resultImage.style.transform = "scale(1.02)";
        setTimeout(() => {
          resultImage.style.transform = "scale(1)";
        }, 120);

        const c2 = lotteryState.config;
        if (outcome === "win") {
          resultText.textContent = c2.winText || "当たり！";
          resultText.classList.add("is-win");
          playSafe(resultWinSound);
          launchConfetti();
          gachaButtons.forEach((btn) => btn.classList.add("is-win"));
        } else {
          resultText.textContent = "ハズレ…";
          resultText.classList.add("is-lose");
          playSafe(resultLoseSound);
        }


        isSpinning = false;
        updateButtonsState();
      }, SPIN_DURATION_MS);
    }

    gachaButtons.forEach((btn) => {
      btn.addEventListener("click", spinGacha);
    });
    undoButton.addEventListener("click", undoLastDraw);
    nextPersonButton.addEventListener("click", prepareForNextPerson);
    nextPartButton.addEventListener("click", () => {
      if (
        confirm(
          "次の部を開始し、カウントをリセットします。よろしいですか？"
        )
      ) {
        nextPart();
      }
    });
    detailsToggle.addEventListener("click", () => {
      const open = detailsPanel.classList.toggle("open");
      detailsToggle.textContent = open ? "詳細を隠す" : "詳細を表示";
    });

    // ===== 抽選設定 UI =====
    if (applyConfigButton) {
      applyConfigButton.addEventListener("click", () => {
        const totalTickets = parseInt(inputTotalTickets.value, 10);
        const totalWinsInput = parseInt(inputTotalWins.value, 10);
        const winText = inputWinText.value.trim() || "大当たり！";
        const titleText = inputTitle.value.trim() || "ローカルガチャ抽選機";

        if (isNaN(totalTickets) || totalTickets <= 0) {
          alert("総くじ数は1以上の整数で入力してください。");
          return;
        }
        if (isNaN(totalWinsInput) || totalWinsInput < 0) {
          alert("合計当たり本数は0以上の整数で入力してください。");
          return;
        }

        const rows = document.querySelectorAll(".image-setting-row");
        const prizes = [];
        let sumPrizeWins = 0;

        rows.forEach((row) => {
          const key = row.getAttribute("data-key");
          const labelInput = row.querySelector(".prize-label-input");
          const enabledEl = row.querySelector(".prize-enabled");
          const isWinEl = row.querySelector(".prize-is-win");
          const winCountInput = row.querySelector(".prize-win-count");

          const enabled = enabledEl ? enabledEl.checked : true;
          let isWin = isWinEl ? isWinEl.checked : false;
          let winCount = parseInt(winCountInput ? winCountInput.value : "0", 10);

          if (!enabled) {
            isWin = false;
            winCount = 0;
          }
          if (isNaN(winCount) || winCount < 0) {
            winCount = 0;
          }

          if (isWin && winCount > 0) {
            sumPrizeWins += winCount;
          } else {
            winCount = 0;
          }

          const labelRaw = labelInput ? labelInput.value : "";
          prizes.push({
            key,
            label: labelRaw && labelRaw.trim() !== "" ? labelRaw.trim() : key + "賞",
            defaultPath: key.toLowerCase() + ".png",
            enabled,
            isWin,
            winCountTotal: winCount,
          });
        });

        if (sumPrizeWins !== totalWinsInput) {
          alert(
            "各画像の当たり本数の合計 (" +
              sumPrizeWins +
              ") と、合計当たり本数 (" +
              totalWinsInput +
              ") が一致していません。"
          );
          return;
        }
        if (totalWinsInput > totalTickets) {
          alert("合計当たり本数は総くじ数以下にしてください。");
          return;
        }

        lotteryState.prizes = prizes;
        lotteryState.config.totalTickets = totalTickets;
        lotteryState.config.totalWins = totalWinsInput;
        lotteryState.config.title = titleText;
        lotteryState.config.winText = winText;

        resetStateForCurrentPart();
        saveLotteryState();
        updateConfigInputs();
        updateTitleDisplay();
      });
    }

    // 挑戦回数設定
    applySessionButton.addEventListener("click", () => {
      const v = inputSessionDraws.value.trim();
      if (v === "") {
        lotteryState.config.maxSessionDraw = null;
        lotteryState.state.sessionRemainingDraws = null;
      } else {
        const num = parseInt(v, 10);
        if (isNaN(num) || num <= 0) {
          alert("挑戦回数は1以上の整数で入力してください。");
          return;
        }
        lotteryState.config.maxSessionDraw = num;
        lotteryState.state.sessionRemainingDraws = num;
      }
      lotteryState.lastDraw = null;
      saveLotteryState();
      updateStatusDisplay();
      updateButtonsState();
    });

    // ===== 画像設定 UI =====
    function refreshImagePreviews() {
      const rows = document.querySelectorAll(".image-setting-row");
      rows.forEach((row) => {
        const key = row.getAttribute("data-key");
        const preview = row.querySelector(".image-preview");
        if (imageSources[key]) {
          preview.src = imageSources[key];
          preview.style.opacity = "1";
        } else {
          const defPath = key.toLowerCase() + ".png";
          preview.src = defPath;
          preview.style.opacity = "0.5";
        }
      });
    }

    function syncPrizeUIFromState() {
      const prizes = lotteryState.prizes || [];
      const rows = document.querySelectorAll(".image-setting-row");
      rows.forEach((row) => {
        const key = row.getAttribute("data-key");
        const prize = prizes.find((p) => p.key === key);
        const enabledEl = row.querySelector(".prize-enabled");
        const isWinEl = row.querySelector(".prize-is-win");
        const winCountInput = row.querySelector(".prize-win-count");
        const labelInput = row.querySelector(".prize-label-input");

        if (prize) {
          if (enabledEl) enabledEl.checked = !!prize.enabled;
          if (isWinEl) isWinEl.checked = !!prize.isWin;
          if (winCountInput)
            winCountInput.value =
              typeof prize.winCountTotal === "number"
                ? prize.winCountTotal
                : 0;
          if (labelInput)
            labelInput.value = prize.label || (prize.key + "賞");
        }
      });
    }

    function setupImageSettings() {
      const rows = document.querySelectorAll(".image-setting-row");
      rows.forEach((row) => {
        const key = row.getAttribute("data-key");
        const fileInput = row.querySelector('input[type="file"]');
        const clearBtn = row.querySelector(".clear-btn");

        fileInput.addEventListener("change", () => {
          const file = fileInput.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            imageSources[key] = e.target.result;
            saveImageSources();
            refreshImagePreviews();
          };
          reader.readAsDataURL(file);
        });

        clearBtn.addEventListener("click", () => {
          delete imageSources[key];
          saveImageSources();
          fileInput.value = "";
          refreshImagePreviews();
        });
      });

      refreshImagePreviews();
      syncPrizeUIFromState();
    }

    // ===== サウンド設定 UI =====
    function setupSoundSettings() {
      const rows = document.querySelectorAll(".sound-setting-row");
      rows.forEach((row) => {
        const key = row.getAttribute("data-sound-key");
        const fileInput = row.querySelector('input[type="file"]');
        const clearBtn = row.querySelector(".sound-clear-btn");

        fileInput.addEventListener("change", () => {
          const file = fileInput.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            soundSources[key] = e.target.result;
            saveSoundSources();

            if (key === "start") {
              startSound = createAudio(getSoundSrc("start", "roulette.mp3"));
            } else if (key === "resultWin") {
              resultWinSound = createAudio(
                getSoundSrc("resultWin", "atari.mp3")
              );
            } else if (key === "resultLose") {
              resultLoseSound = createAudio(
                getSoundSrc("resultLose", "hazure.mp3")
              );
            }
          };
          reader.readAsDataURL(file);
        });

        clearBtn.addEventListener("click", () => {
          delete soundSources[key];
          saveSoundSources();
          fileInput.value = "";

          if (key === "start") {
            startSound = createAudio(getSoundSrc("start", "roulette.mp3"));
          } else if (key === "resultWin") {
            resultWinSound = createAudio(
              getSoundSrc("resultWin", "atari.mp3")
            );
          } else if (key === "resultLose") {
            resultLoseSound = createAudio(
              getSoundSrc("resultLose", "hazure.mp3")
            );
          }
        });
      });

      startSound = createAudio(getSoundSrc("start", "roulette.mp3"));
      resultWinSound = createAudio(getSoundSrc("resultWin", "atari.mp3"));
      resultLoseSound = createAudio(getSoundSrc("resultLose", "hazure.mp3"));
    }

    setupImageSettings();
    setupSoundSettings();
  </script>

</body>
</html>
